version: '3.7'

services:
  kraken_designer:
    container_name: pg-kraken_designer
    image: devopsfaith/krakendesigner:latest
    ports:
      - 8787:80
    dns: "192.168.1.13"
    networks:
      internal:

  krakend_ce:
    container_name: pg-krakend_ce
    image: devopsfaith/krakend:1.4.1
    volumes:
      - ./config/krakend:/etc/krakend
    ports:
      - "1234:1234"
      - "8080:8080"
      - "8090:8090"
    dns: "192.168.1.13"
    networks:
      internal:
    depends_on:
      - consul-server

  consul-server:
    image: consul
    container_name: pg-consul-server
    restart: always
    volumes:
      - ./config/consul/server.json:/consul/config/server.json:ro
    environment:
      - CONSUL_ALLOW_PRIVILEDGED_PORTS
    ports:
      - "8500:8500"
      - "53:8600/tcp"
      - "53:8600/udp"
      - "8600:8600/tcp"
      - "8600:8600/udp"

  consul-client:
    image: hashicorp/consul:1.10.0
    container_name: pg-consul-client
    restart: always
    volumes:
      - ./config/consul/client.json:/consul/config/client.json:ro
    networks:
      internal:
    command: "agent"
    dns: "192.168.1.13"

  yarn:
    image: node:14
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - modules:/workspace/node_modules
      - yarncache:/workspace/.yarn-cache
    environment:
      - YARN_CACHE_FOLDER=/workspace/.yarn-cache
    entrypoint: yarn

  rabbitmq:
    build:
      context: ./config/rabbitmq/
      dockerfile: ./Dockerfile
    ports:
      - 4369:4369
      - 5671:5671
      - 5672:5672
      - 15672:15672
    environment:
      - RABBITMQ_DEFAULT_USER=local
      - RABBITMQ_DEFAULT_PASS=password
    networks:
      - default

  db:
    image: bitnami/postgresql
    environment:
      - POSTGRESQL_PASSWORD=password
      - POSTGRESQL_DATABASE=db
    ports:
      - '5432:5432'
    networks:
      - default

  account:
    image: node:14
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - modules:/workspace/node_modules
    entrypoint: yarn account-service:dev
    depends_on:
      - rabbitmq
      - db
      - consul-server
    networks:
      - default

  currency:
    image: node:14
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - modules:/workspace/node_modules
    entrypoint: yarn currency-service:dev
    depends_on:
      - rabbitmq
      - db
    networks:
      - default

  transaction:
    image: node:14
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - modules:/workspace/node_modules
    entrypoint: yarn transaction-service:dev
    depends_on:
      - rabbitmq
      - db
      - account
      - currency
    networks:
      - default

  public-gateway:
    image: node:14
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - modules:/workspace/node_modules
    entrypoint: yarn public-gateway:dev
    ports:
      - 3000:3000
    depends_on:
      - rabbitmq
      - db
      - account
      - currency
      - consul-server
    networks:
      - default

#  traefik:
#    image: traefik:2.4
#    command: --api --docker
#    ports:
#      - 80:80
#      - 443:443
#    volumes:
#      - /var/run/docker.sock:/var/run/docker.sock
#      - /dev/null:/traefik.toml
#    networks:
#      default:
#      internal:

volumes:
  modules:
  yarncache:

networks:
  default:
  internal:

